from typing import List, Dict
import pandas as pd



def make_prompt_evalution_diet(today_diet: List[str]) -> str:
        return f"""
당신은 IBS 환자를 위한 식단 평가자 입니다.

출력은 반드시 <BEGIN>과 <END> 사이의 내용만 포함해야 하며, <BEGIN>,<END> 이 두 태그 자체는 포함하지 마십시오.

오늘 환자가 섭취한 하루 동안의 음식 리스트인 {today_diet}를 분석하여,
IBS 환자 맞춤형 식단 평가 문장을 1~2문장으로 간단 명료하게 제공하십시오.(포드맵, 식이섬유 등 내용 포함)


<BEGIN>
평가: 평가 문장
<END>


어떠한 경우에도 추가적인 설명이나 다른 내용을 출력하지 마십시오. 반드시 위 형식에만 맞게 출력해야 합니다.
""".strip()


def build_prompt_ko_from_csv(
    table_food: str,
    allergies: List[str],
    restrictions: List[str],
    recent_3d: List[str],
    max_chars: int = 6000
) -> str:
    # 컬럼 소문자 통일


    prompt = f"""
당신은 IBS 환자를 위한 전문 식단 조언자입니다.  
아래는 Excel(CSV)에서 추출된 음식 리스트 표입니다. 최소한 다음과 같은 컬럼이 있습니다: food, fodmap, fiber  모든 비교는 대소문자 구분 없이 처리합니다.

표:
{table_food}

당신은 위 표에 있는 음식 리스트를 이용해서 아래의 [TASK]에 적혀있는 내용에 따라 식단을 추천해야합니다.

[TASK]
1) 반드시 표에 있는 음식만 사용(새로운 음식 금지).
2) 필터링: 최근섭취 {recent_3d}, 기피 {restrictions}, 알러지 {allergies} 제외 우선.
3) 식사 적합성:
   - 아침: 부드럽고 저지방(죽/요거트 대체/순한 과일 등)
   - 점심: 단백질(살코기)+저FODMAP 탄수화물+수용성 채소
   - 저녁: 점심보다 가볍고 순한 저FODMAP
   - 각 끼니는 Main/Carb/Veg/Fruit/Optional 조합을 고려
       • Main(단백질 중심, 저지방·순함)
       • Carb(저FODMAP 탄수화물)
       • Veg/Fruit(수용성 섬유 위주 채소·과일)
       • Optional(국/부드러운 보조식/발효유 대체 등; 음료만 단독 금지)
   - ‘죽(=porridge)’은 **하루 전체에서 최대 1회**만 허용(죽 단독 금지)
   
4) 선택 알고리즘: 규칙 적합성 > 다양성(주재료 반복 회피) > 덜 자극적 > 알파벳순
5) 각 끼니는 **정확히 6개 항목**, 쉼표+공백(“, ”)으로 구분
6) 금지 문자: 콜론(:), 세미콜론(;), 괄호(), 대괄호[], 따옴표, 하이픈


[출력 형식 — 이 규칙을 반드시 지켜야 함]
- <BEGIN>과 <END> 사이의 형태를 완벽히 유지하고, 항목1~6만 추천 음식으로 대체하여 출력해야함
- <BEGIN>, <END> 두 태그 자체는 출력 금지.
- <BEGIN>과 <END> 사이에는 **정확히 4줄**만 존재해야 함(빈 줄 금지).
- "아침:", "점심:", "저녁:", "요약:" 문구는 꼭 포함해야 함.
- 각 줄은 120자 이내.

<BEGIN>
아침: 항목1, 항목2, 항목3, 항목4, 항목5, 항목6
점심: 항목1, 항목2, 항목3, 항목4, 항목5, 항목6
저녁: 항목1, 항목2, 항목3, 항목4, 항목5, 항목6
요약: 추천 음식들의 전체적인 요약 한 문장 (추천 사유 등 포함)
<END>
""".strip()
    return prompt

# def build_prompt_ko_from_csv(
#     table_food: str,
#     allergies: List[str],
#     restrictions: List[str],
#     recent_3d: List[str],
#     max_chars: int = 6000
# ) -> str:
#     # 컬럼 소문자 통일


#     prompt = f"""
# 당신은 IBS 환자를 위한 전문 식단 조언자입니다.  
# 아래는 Excel(CSV)에서 추출된 음식 리스트 표입니다. 최소한 다음과 같은 컬럼이 있습니다: food, fodmap, fiber  모든 비교는 대소문자 구분 없이 처리합니다.

# 표:
# {table_food}

# 당신은 위 표에 있는 음식 리스트를 이용해서 아래의 TASK에 적혀있는 내용에 따라 식단을 추천해야합니다.

# TASK:
# 1) 반드시 표에 있는 음식만 사용하십시오. 새로운 음식을 만들어내지 마십시오.
# 2) 필터링 규칙:
#    - {recent_3d} 내에 있는 음식은 어느정도 제외합니다.
#    - {restrictions} 내에 있는 기피 사항들도 고려하여 제외합니다.
#    - {allergies} 내에 있는 알러지 사항들도 고려하여 제외합니다.
# 3) 식사 적합성 규칙:
#    - 아침: 부드럽고 소화 잘 되며 저지방 음식, 자극적/기름진 음식은 피함. (예: 죽, 요거트 대체식, 부드러운 저포드맵 과일)
#    - 점심: 균형 잡힌 구성(살코기 단백질 + 저포드맵 탄수화물 + 수용성 채소).
#    - 저녁: 점심보다 가볍게, 기름진/자극적인 음식 피하고 순하고 소화 잘 되는 저포드맵 음식.
#    - 각 끼니는 아래 4개 역할을 기준으로 구성한다.
#      • Main(단백질 중심, 저지방·순함)
#      • Carb(저FODMAP 탄수화물)
#      • Veg/Fruit(수용성 섬유 위주 채소·과일)
#      • Optional(국/부드러운 보조식/발효유 대체 등; 음료만 단독 금지)
#    -‘죽(=porridge)’은 **하루 전체에서 최대 1회**만 허용하며, 그 끼니에서도 Main/Carb/Veg를 반드시 함께 구성해야 한다(죽 단독 금지)
# 4) 선택 알고리즘 (무작위 금지):
#    a) 위의 식사 적합성 규칙을 기준으로 우선순위화합니다.
#    b) 다양성을 확보하여 같은 주재료를 반복하지 않습니다.
#    c) IBS 환자에게 더 순한 음식(부드럽고, 덜 기름지거나 자극적이지 않은 음식)을 우선합니다.
#    d) 여전히 동점이면 food 이름을 알파벳순으로 정합니다.
# 5) 아침/점심/저녁 각각 고유한 음식을 선택해 하루 식단을 구성합니다.
# 6) 각 끼니별로 6~7개의 음식을 선택합니다.
# 7) 모든 답변은 한글로 해야 합니다.

# 출력 형식은 아래 <BEGIN>과 <END> 사이의 형식과 정확히 일치해야 하며, 추가 설명이나 다른 텍스트는 절대 포함하지 마십시오.
# 각 끼니별로 [추천식사] 에 해당 음식들을 나열하십시오.
# <BEGIN>, <END> 이 두 태그 자체는 포함하지 마십시오.

# <BEGIN>
# [Dietary Recommendation]
# Breakfast: [추천 식사]
# Lunch: [추천 식사]
# Dinner: [추천 식사]
# Summary: [간단한 이유 및 주의사항]
# <END>
# """.strip()
#     return prompt



def make_sleep_prompt_ko(context: str, today_sleep: float) -> str:
    return f"""
당신은 IBS 환자를 위한 수면 보조자입니다.

아래 <BEGIN>과 <END> 사이의 형식으로만 답변해야 합니다.
출력은 반드시 <BEGIN>과 <END> 사이의 내용만 포함해야 하며, <BEGIN>, <END> 이 두 태그 자체는 포함하지 마십시오.

<BEGIN>
평가: 평가 문장
목표: "NUMBER" 
<END>

첫 번째 “평가”에는 오늘 수면 시간({today_sleep:.1f} 시간)에 대한 한 문장 평가를 작성하십시오.  
(예: "오늘은 충분히 수면을 취하지 못했으므로 내일은 더 많은 수면이 필요합니다.")  

두 번째 “목표”에는 내일의 목표 수면 시간을 "NUMBER"로 작성하십시오.

아래 Guidance를 참고하여 "NUMBER"를 결정하십시오.

어떠한 경우에도 추가적인 설명이나 다른 내용을 출력하지 마십시오. 반드시 위 형식에만 맞게 출력해야 합니다.


Guidance  
- 문헌이 제공되면 이를 참고하고, 없을 경우 성인의 일반적인 권장 수면 시간(예: 약 7~8시간)과 오늘의 패턴을 활용하십시오.  
- 오늘 수면이 짧았다면, 현실적이고 안전한 목표를 설정해야 하며 극단적인 변화는 피하십시오.  

제공된 임상 문헌 (있다면, 출력에 포함하지 마십시오):
{context}
""".strip()


def make_exercise_prompt_ko(context: str, week_step: List[int]) -> str:
    return f"""
당신은 IBS 환자를 위한 운동 보조자입니다.

아래 <BEGIN>과 <END> 사이의 형식으로만 답변해야 합니다.
출력은 반드시 <BEGIN>과 <END> 사이의 내용만 포함해야 하며,  <BEGIN>, <END> 이 두 태그 자체는 포함하지 마십시오.

<BEGIN>
평가: 평가 문장
목표: "NUMBER" 
<END>

첫 번째 “평가”에는 이번주 걸음 수({week_step})에 대한 한 문장 평가를 작성하십시오.  
(예: "한 주 동안 규칙적으로 걷지 못했네요. 매일 제공되는 목표치를 달성하여 규칙적인 산책을 하세요")  

두 번째 “목표”에는 내일의 목표 걸음 수를 "NUMBER"로 작성하십시오.

아래 Guidance를 참고하여 "NUMBER"를 결정하십시오.

어떠한 경우에도 추가적인 설명이나 다른 내용을 출력하지 마십시오. 반드시 위 형식에만 맞게 출력해야 합니다.


Guidance  
- 문헌이 제공되면 이를 참고하고, 없을 경우 일반적인 IBS 환자의 안전한 걷기 권장량을 따르십시오.  
- 오늘 걸음 수가 낮으면, 점진적이고 현실적으로 증가시켜야 합니다.  

제공된 임상 문헌 (있다면, 출력에 포함하지 마십시오):
{context}
""".strip()